<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <style>
        /* --- CSS STYLING --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: white; margin: 0; display: flex; justify-content: center; height: 100vh; }
        #app { width: 100%; max-width: 600px; background: #1e1e1e; display: flex; flex-direction: column; height: 100%; border-left: 1px solid #333; border-right: 1px solid #333; }
        
        /* Header */
        header { padding: 15px; background: #075E54; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 1.2rem; }
        
        /* Chat Area */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        
        /* Message Bubbles */
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; position: relative; }
        .sent { align-self: flex-end; background-color: #005c4b; border-bottom-right-radius: 5px; }
        .received { align-self: flex-start; background-color: #333; border-bottom-left-radius: 5px; }
        .timestamp { font-size: 0.65rem; color: #aaa; text-align: right; margin-top: 5px; }
        
        /* Images in chat */
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }

        /* Input Area */
        form { background: #1e1e1e; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #333; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: none; background: #2c2c2c; color: white; outline: none; }
        button { background: #00a884; border: none; padding: 10px 20px; color: white; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        /* Media Buttons */
        .media-btn { background: none; color: #888; padding: 5px; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
        .media-btn:hover { color: white; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <h1 id="chatTitle">Private Encrypted Room</h1>
        <small id="status">Connecting...</small>
    </header>

    <div id="messages">
        </div>

    <form id="chatForm">
        <input type="file" id="fileInput" accept="image/*">
        
        <button type="button" class="media-btn" onclick="document.getElementById('fileInput').click()">ðŸ“·</button>
        
        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button type="submit">âž¤</button>
    </form>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // --- 1. PASTE YOUR CONFIG HERE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBSeCvG-9ihBBD4njkY6ETNg2Li7RQk1fw",
  	authDomain: "chat-yo-f5a5f.firebaseapp.com",
  	projectId: "chat-yo-f5a5f",
  	storageBucket: "chat-yo-f5a5f.firebasestorage.app",
  	messagingSenderId: "63074597640",
  	appId: "1:63074597640:web:23b400e48d3e574f530abd"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 2. SECURITY CHECK ---
    const secretCode = "1234"; // CHANGE THIS PASSWORD!
    const userCode = prompt("Enter the Room Password:");
    
    let username = "Friend";
    
    if (userCode !== secretCode) {
        document.body.innerHTML = "<h1 style='text-align:center; padding:50px;'>â›” Access Denied</h1>";
    } else {
        username = prompt("What is your name?") || "Anonymous";
        document.getElementById('status').innerText = "Online";
    }

    // --- 3. SENDING MESSAGES ---
    const form = document.getElementById('chatForm');
    const input = document.getElementById('msgInput');
    const messagesDiv = document.getElementById('messages');
    const fileInput = document.getElementById('fileInput');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        try {
            await addDoc(collection(db, "chats"), {
                text: text,
                user: username,
                timestamp: serverTimestamp(),
                type: 'text'
            });
            input.value = '';
        } catch (err) {
            console.error("Error sending:", err);
        }
    });

    // --- 4. HANDLING IMAGES (Base64) ---
    // Note: For heavy videos, you usually need Firebase Storage. 
    // This method works for images by converting them to text strings.
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
            const base64String = event.target.result;
            try {
                await addDoc(collection(db, "chats"), {
                    image: base64String,
                    user: username,
                    timestamp: serverTimestamp(),
                    type: 'image'
                });
            } catch (err) {
                alert("Image too large for free tier database!");
            }
        };
        reader.readAsDataURL(file);
    });

    // --- 5. RECEIVING MESSAGES (Real-time) ---
    const q = query(collection(db, "chats"), orderBy("timestamp", "asc"));
    
    onSnapshot(q, (snapshot) => {
        messagesDiv.innerHTML = ""; // Clear current view
        snapshot.forEach((doc) => {
            const msg = doc.data();
            const div = document.createElement('div');
            
            // Check if I sent it or Friend sent it
            const isMe = msg.user === username;
            div.className = `msg ${isMe ? 'sent' : 'received'}`;

            // Render content based on type
            let content = "";
            if(msg.type === 'text') {
                content = `<strong>${msg.user}</strong><br>${msg.text}`;
            } else if (msg.type === 'image') {
                content = `<strong>${msg.user}</strong><br><img src="${msg.image}" onclick="window.open(this.src)">`;
            }

            // Timestamp formatting
            const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';

            div.innerHTML = `${content} <div class="timestamp">${time}</div>`;
            messagesDiv.appendChild(div);
        });
        
        // Auto scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

</script>
</body>
</html>
